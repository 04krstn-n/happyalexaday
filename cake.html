<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Birthday Cake</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-image: linear-gradient(45deg, #ff9cd6, #ffffff);
        overflow: hidden;
      }
      canvas {
        width: 90vw;
        height: 80vh;
        max-width: 800px;
        max-height: 800px;
      }

      #lyrics {
        position: fixed;
        top: 80%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        font-family: "Brush Script MT", cursive;
        font-size: 40px;
        color: rgba(255, 78, 145, 0.7);
        white-space: pre-line;
        opacity: 0;
        transition: opacity 1.5s ease-in-out;
        z-index: 0;
        pointer-events: none;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: #fff0f5;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0px 5px 25px rgba(0, 0, 0, 0.3);
        animation: popIn 0.5s ease;
      }

      .modal-content h1 {
        font-family: "Brush Script MT", cursive;
        font-size: 2.5em;
        color: #ff1493;
      }

      .modal-content p {
        font-size: 1.2em;
        color: #333;
      }

      #closeBtn {
        float: right;
        font-size: 1.5em;
        cursor: pointer;
        color: #888;
      }
      #closeBtn:hover {
        color: #ff1493;
      }

      @keyframes popIn {
        from {
          transform: scale(0.5);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="cake"></canvas>

    <div id="birthdayModal" class="modal">
      <div class="modal-content">
        <span id="closeBtn">&times;</span>
        <p>Hellooooo! Happy happy birthday, bebiiii!</p>
        <p>I hope this day brings you lots of joy and surprises</p>
         <p>that will make you the happiest pooooo!</p>
         <p>You truly deserve the best and deserve mo </p>
         <p>ang maraming  maramingggg greetingsssss mwehhehehehe</p>
         <p>Happy birthday again, Alexa! Enjoy pooooo haaa!!!</p>
      </div>
    </div>

    <audio id="birthdaySong" src="hbd.mp3"></audio>
    <div id="lyrics"></div>

    <script>
      const canvas = document.getElementById("cake");
      const ctx = canvas.getContext("2d");

      function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = canvas.clientWidth * dpr;
        canvas.height = canvas.clientHeight * dpr;
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
      }
      window.addEventListener("resize", () => {
        resizeCanvas();
        setupIcing();
      });
      resizeCanvas();

      let flamesOn = true;
      let smokeParticles = [];
      let icingPaths = [];
      let confettiParticles = [];
      let confettiActive = false;

      let cakeColor = "#ff69b4";
      let icingColor = "#ffffff";

      let popScale = 0;
      let popping = false;
      let popDirection = 1;
      let popOvershot = false;

      function triggerPop() {
        popping = true;
        popScale = 0;
        popDirection = 1;
        popOvershot = false;
      }

      function roundRect(x, y, w, h, r, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.lineTo(x + w - r, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + r);
        ctx.lineTo(x + w, y + h - r);
        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        ctx.lineTo(x + r, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - r);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.closePath();
        ctx.fill();
      }

      function generateIcing(x, y, width, maxDrop, spacing) {
        let points = [];
        for (let i = 0; i <= width; i += spacing) {
          const dripHeight = Math.random() * maxDrop + 8;
          points.push({
            x: x + i,
            y: y + dripHeight,
            baseY: y + dripHeight,
            speed: Math.random() * 0.02 + 0.01,
          });
        }
        return points;
      }

      function drawIcing(points, startX, startY, width) {
        ctx.fillStyle = icingColor;
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        points.forEach((p, i) => {
          const prev = points[i - 1] || { x: startX, y: startY };
          ctx.quadraticCurveTo(prev.x + (p.x - prev.x) / 2, p.y, p.x, startY);
        });
        ctx.lineTo(startX + width, startY);
        ctx.lineTo(startX, startY);
        ctx.closePath();
        ctx.fill();
      }

      function drawTeardrop(x, y, size, flicker) {
        ctx.fillStyle = "orange";
        ctx.beginPath();
        ctx.moveTo(x, y - size * (1.5 + flicker));
        ctx.quadraticCurveTo(
          x + size * (1 + flicker),
          y - size * 0.5,
          x,
          y + size
        );
        ctx.quadraticCurveTo(
          x - size * (1 + flicker),
          y - size * 0.5,
          x,
          y - size * (1.5 + flicker)
        );
        ctx.closePath();
        ctx.fill();
      }

      function drawCake() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.scale(popScale, popScale);
        ctx.translate(-canvas.width / 2, -canvas.height / 2);

        const w = canvas.clientWidth;
        const h = canvas.clientHeight;

        const baseW = w * 0.55;
        const baseH = h * 0.12;
        const midW = w * 0.45;
        const midH = h * 0.1;
        const topW = w * 0.35;
        const topH = h * 0.08;

        const baseX = (w - baseW) / 2;
        const baseY = h * 0.68;
        const midX = (w - midW) / 2;
        const midY = baseY - midH - 8;
        const topX = (w - topW) / 2;
        const topY = midY - topH - 8;

        roundRect(baseX, baseY, baseW, baseH, 20, cakeColor);
        drawIcing(icingPaths[0], baseX, baseY, baseW);

        roundRect(midX, midY, midW, midH, 15, cakeColor);
        drawIcing(icingPaths[1], midX, midY, midW);

        roundRect(topX, topY, topW, topH, 12, cakeColor);
        drawIcing(icingPaths[2], topX, topY, topW);

        const candleX = [w * 0.42, w * 0.5, w * 0.58];
        candleX.forEach((x, idx) => {
          ctx.fillStyle = "#87ceeb";
          ctx.fillRect(x - w * 0.01, topY - h * 0.08, w * 0.02, h * 0.08);

          if (flamesOn) {
            const flicker = Math.sin(Date.now() * 0.005 + idx) * 0.2;
            drawTeardrop(x, topY - h * 0.1, w * 0.02, flicker);
          } else {
            smokeParticles.forEach((p) => {
              ctx.beginPath();
              ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
              ctx.fillStyle = `rgba(100,100,100,${p.alpha})`;
              ctx.fill();
            });
          }
        });

        if (confettiActive) {
          updateConfetti();
        }

        ctx.restore();

        if (popping) {
          if (popDirection === 1) {
            popScale += 0.05;
            if (popScale >= 1.3) {
              popDirection = -1;
              popOvershot = true;
            }
          } else {
            popScale -= 0.02;
            if (popScale <= 1) {
              popScale = 1;
              popping = false;
            }
          }
        }
      }

      async function initMic() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          await audioContext.resume(); // ðŸ”‘ fix autoplay policy
          const analyser = audioContext.createAnalyser();
          analyser.fftSize = 256; // smaller buffer, more sensitive
          const mic = audioContext.createMediaStreamSource(stream);
          mic.connect(analyser);

          const data = new Uint8Array(analyser.fftSize);

          function detectBlow(time) {
            analyser.getByteTimeDomainData(data);

            let sum = 0;
            for (let i = 0; i < data.length; i++) {
              let deviation = data[i] - 128;
              sum += Math.abs(deviation);
            }
            let volume = sum / data.length;

            if (volume > 20 && flamesOn) {
              flamesOn = false;
              createSmoke();
              createConfetti();
              confettiActive = true;

              setTimeout(() => {
                confettiActive = false;

                document.getElementById("birthdayModal").style.display = "flex";
              }, 3500);
            }

            updateSmoke();
            updateIcing(time);
            drawCake();
            requestAnimationFrame(detectBlow);
          }

          detectBlow(0);
        } catch (err) {
          alert("Microphone access denied!");
        }
      }

      function createSmoke() {
        for (let i = 0; i < 50; i++) {
          smokeParticles.push({
            x: canvas.width * (0.42 + 0.16 * Math.random()),
            y: canvas.height * 0.35,
            size: Math.random() * 4 + 2,
            alpha: 1,
            speedY: Math.random() * -1.5 - 1,
          });
        }
      }
      function updateSmoke() {
        smokeParticles.forEach((p) => {
          p.y += p.speedY;
          p.alpha -= 0.01;
        });
        smokeParticles = smokeParticles.filter((p) => p.alpha > 0);
      }

      function updateIcing(time) {
        icingPaths.forEach((layer) => {
          layer.forEach((p) => {
            p.y = p.baseY + Math.sin(time * p.speed) * 1.5;
          });
        });
      }

      function setupIcing() {
        const w = canvas.clientWidth;
        const h = canvas.clientHeight;

        const baseW = w * 0.55;
        const midW = w * 0.45;
        const topW = w * 0.35;

        const baseX = (w - baseW) / 2;
        const baseY = h * 0.68;
        const midX = (w - midW) / 2;
        const midY = baseY - h * 0.1 - 8; // narrower gap
        const topX = (w - topW) / 2;
        const topY = midY - h * 0.08 - 8; // narrower gap

        icingPaths = [
          generateIcing(baseX, baseY, baseW, 20, 20),
          generateIcing(midX, midY, midW, 15, 18),
          generateIcing(topX, topY, topW, 12, 15),
        ];
      }

      function createConfetti() {
        for (let i = 0; i < 150; i++) {
          confettiParticles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * -canvas.height,
            size: Math.random() * 6 + 4,
            color: `hsl(${Math.random() * 360}, 80%, 60%)`,
            speedX: Math.random() * 2 - 1,
            speedY: Math.random() * 3 + 2,
            rotation: Math.random() * 360,
            rotationSpeed: Math.random() * 5 - 2.5,
          });
        }
      }
      function updateConfetti() {
        confettiParticles.forEach((p) => {
          p.x += p.speedX;
          p.y += p.speedY;
          p.rotation += p.rotationSpeed;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate((p.rotation * Math.PI) / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
          ctx.restore();
        });
      }

      const song = document.getElementById("birthdaySong");
      const lyricsDiv = document.getElementById("lyrics");

      const lyrics = [
        "ðŸŽ¶ Happy Birthday to you ðŸŽ¶",
        "ðŸŽ¶ Happy Birthday to you ðŸŽ¶",
        "ðŸŽ¶ Happy Birthday dear Alexa ðŸŽ¶",
        "ðŸŽ¶ Happy Birthday to you ðŸŽ¶",
        "Happy Birthday, Alexa!",
      ];

      function showLyrics() {
        let i = 0;
        lyricsDiv.style.opacity = 0;

        function nextLine() {
          if (i < lyrics.length) {
            lyricsDiv.textContent = lyrics[i];
            lyricsDiv.style.opacity = 1;

            if (i === lyrics.length - 1) {
              return;
            }

            setTimeout(() => {
              lyricsDiv.style.opacity = 0;
              i++;
              setTimeout(nextLine, 1500);
            }, 2500);
          }
        }

        nextLine();
      }

      setTimeout(() => {
        song.currentTime = 0;
        song.play();
        showLyrics();
        triggerPop();
      }, 1500);

      song.onended = () => {
        lyricsDiv.textContent = "ðŸŽ‚ Blow the candle ðŸŽ‚";
        lyricsDiv.style.opacity = 1;
      };

      setupIcing();
      initMic();

      function animate() {
        drawCake();
        requestAnimationFrame(animate);
      }
      animate();

      document.getElementById("closeBtn").onclick = function () {
        document.getElementById("birthdayModal").style.display = "none";
      };
    </script>
  </body>
</html>
